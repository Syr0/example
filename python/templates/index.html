<!DOCTYPE html>
<html>
<head>
    <title>Global Ship Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; }
        #top-bar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; z-index: 1000;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 20px;
        }
        .form-group { display: flex; align-items: center; gap: 5px; }
        .form-input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 8px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button.active { background-color: #c82333; }
        #status { font-size: 14px; color: #555; }
    </style>
</head>
<body>
    <div id="top-bar">
        <div class="form-group">
            <i class="fa-solid fa-search"></i>
            <input type="text" id="search" class="form-input" placeholder="Search...">
        </div>
        <div class="form-group">
            <i class="fa-solid fa-clock"></i>
            <select id="hours" class="form-input">
                <option value="1">Last 1 Hour</option>
                <option value="6">Last 6 Hours</option>
                <option value="24" selected>Last 24 Hours</option>
                <option value="168">Last 7 Days</option>
            </select>
        </div>
        <div class="form-group">
            <button id="draw-whitelist">Whitelist</button>
            <button id="draw-blacklist">Blacklist</button>
            <button id="run-geofence">Run Geo-Fence</button>
            <button id="clear-filters">Clear</button>
        </div>
        <div id="status">Loading...</div>
    </div>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([20, 0], 3);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        let ships = {};
        let drawnItems = new L.FeatureGroup().addTo(map);
        let isDrawing = false;
        let currentDrawType = null;

        const searchInput = document.getElementById('search');
        const hoursSelect = document.getElementById('hours');

        function createShipIcon(heading) {
            return L.divIcon({
                className: 'ship-icon',
                html: `<div style="transform: rotate(${heading}deg);"><svg width="15" height="15" viewBox="0 0 20 20"><polygon points="10,0 20,20 0,20" style="fill:blue;stroke:white;stroke-width:1" /></svg></div>`,
                iconSize: [15, 15], iconAnchor: [7.5, 7.5]
            });
        }

        function updateMap() {
            const bounds = map.getBounds();
            const boundsStr = `${bounds.getSouthWest().lat},${bounds.getSouthWest().lng},${bounds.getNorthEast().lat},${bounds.getNorthEast().lng}`;
            const hours = hoursSelect.value;
            const search = searchInput.value;

            document.getElementById('status').innerText = 'Loading...';
            fetch(`/api/positions?bounds=${boundsStr}&hours=${hours}&search=${search}`)
                .then(res => res.json())
                .then(data => {
                    if (!Array.isArray(data)) { throw new Error("Received invalid data from server."); }
                    const currentShipIds = new Set();
                    data.forEach(ship => {
                        currentShipIds.add(ship.id);
                        const latLng = [ship.lat, ship.lon];
                        if (ships[ship.id]) {
                            ships[ship.id].setLatLng(latLng).setIcon(createShipIcon(ship.heading));
                        } else {
                            ships[ship.id] = L.marker(latLng, { icon: createShipIcon(ship.heading) }).addTo(map);
                        }
                        ships[ship.id].bindPopup(`<b>${ship.name || 'N/A'}</b><br>ID: ${ship.id}`);
                    });

                    for (const shipId in ships) {
                        if (!currentShipIds.has(parseInt(shipId))) {
                            map.removeLayer(ships[shipId]);
                            delete ships[shipId];
                        }
                    }
                    document.getElementById('status').innerText = `Tracking ${data.length} ships`;
                })
                .catch(err => {
                    document.getElementById('status').innerText = 'Error!';
                    console.error(err);
                });
        }

        function startDrawing(type) {
            // ** THE FIX IS HERE **
            // Disable map dragging BEFORE starting to draw.
            map.dragging.disable();
            isDrawing = true;
            currentDrawType = type;
            map.getContainer().style.cursor = 'crosshair';
            document.getElementById(type === 'whitelist' ? 'draw-whitelist' : 'draw-blacklist').classList.add('active');
        }

        map.on('mousedown', function(e) {
            if (!isDrawing) return;
            const startLatLng = e.latlng;
            const rect = L.rectangle([startLatLng, startLatLng], {
                color: currentDrawType === 'whitelist' ? 'green' : 'red',
                weight: 2
            }).addTo(drawnItems);

            map.on('mousemove', function(e) {
                rect.setBounds([startLatLng, e.latlng]);
            });

            map.once('mouseup', function(e) {
                map.off('mousemove');
                isDrawing = false;
                // Re-enable map dragging
                map.dragging.enable();
                map.getContainer().style.cursor = '';
                document.getElementById(currentDrawType === 'whitelist' ? 'draw-whitelist' : 'draw-blacklist').classList.remove('active');
            });
        });

        document.getElementById('draw-whitelist').addEventListener('click', () => startDrawing('whitelist'));
        document.getElementById('draw-blacklist').addEventListener('click', () => startDrawing('blacklist'));

        document.getElementById('run-geofence').addEventListener('click', function() {
            // ... (geo-fence logic remains the same)
        });

        document.getElementById('clear-filters').addEventListener('click', function() {
            drawnItems.clearLayers();
            searchInput.value = "";
            updateMap();
        });

        map.on('moveend', updateMap);
        searchInput.addEventListener('input', () => debounce(updateMap, 500)());
        hoursSelect.addEventListener('change', updateMap);

        function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }

        updateMap();

        // Full geo-fence logic for completeness
        document.getElementById('run-geofence').addEventListener('click', function() {
            const payload = { hours: hoursSelect.value, whitelist: [], blacklist: [] };
            drawnItems.eachLayer(layer => {
                const zone = { type: 'rectangle', bounds: [layer.getBounds().getSouth(), layer.getBounds().getWest(), layer.getBounds().getNorth(), layer.getBounds().getEast()] };
                if (layer.options.color === 'green') { payload.whitelist.push(zone); } else { payload.blacklist.push(zone); }
            });
            document.getElementById('status').innerText = 'Geo-fencing...';
            fetch('/api/geofence', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
                .then(res => res.json())
                .then(data => {
                    for (const shipId in ships) { map.removeLayer(ships[shipId]); }
                    ships = {};
                    data.forEach(ship => { L.polyline(ship.trail, { color: 'purple', weight: 3 }).addTo(map); });
                    document.getElementById('status').innerText = `Found ${data.length} routes.`;
                });
        });
    </script>
</body>
</html>
